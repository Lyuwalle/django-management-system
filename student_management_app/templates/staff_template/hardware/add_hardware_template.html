{% extends 'staff_template/base_template.html' %}

{% block main_content %}
{% load static %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-upload mr-2"></i>上传固件信息
                        </h3>
                    </div>

                    <form role="form" id="uploadForm" action="{% url 'staff_add_hardware_save' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="form-group">
                                <label>固件文件 <small class="text-muted"></small></label>
                                <div class="input-group">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" name="firmware_file" id="firmware_file" required>
                                        <label class="custom-file-label" for="firmware_file">选择文件</label>
                                    </div>
                                </div>
                                <small class="form-text text-muted">支持所有类型文件</small>
                            </div>

                            <div class="form-group">
                                <label>描述 <small class="text-muted">(可选)</small></label>
                                <textarea class="form-control" name="description" rows="3" placeholder="输入固件描述信息"></textarea>
                            </div>
                        </div>

                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary" id="uploadBtn">
                                <i class="fas fa-upload mr-2"></i>上传固件
                            </button>
                            <a href="{% url 'staff_manage_hardware' %}" class="btn btn-secondary ml-2">
                                <i class="fas fa-arrow-left mr-2"></i>返回
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Upload Progress Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="uploadModalLabel">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>固件上传中
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="upload-animation mb-3">
                    <i class="fas fa-microchip fa-3x text-primary mb-3" id="uploadIcon"></i>
                </div>

                <div class="mb-3">
                    <h6 id="fileName" class="text-muted"></h6>
                    <small id="fileSize" class="text-muted"></small>
                </div>

                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                         role="progressbar" id="progressBar"
                         style="width: 0%"
                         aria-valuenow="0"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        <span id="progressText">0%</span>
                    </div>
                </div>

                <div id="uploadStatus" class="text-muted">
                    正在准备上传...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">
                    <i class="fas fa-check-circle mr-2"></i>上传成功
                </h5>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h5>固件上传成功！</h5>
                <p class="text-muted">固件已成功保存到服务器</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="window.location.href='{% url 'manage_hardware' %}'">
                    <i class="fas fa-list mr-2"></i>查看固件列表
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorModalLabel">
                    <i class="fas fa-exclamation-triangle mr-2"></i>上传失败
                </h5>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-times-circle fa-4x text-danger mb-3"></i>
                <h5>上传失败</h5>
                <p class="text-muted" id="errorMessage">请检查文件并重试</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-arrow-left mr-2"></i>返回
                </button>
                <button type="button" class="btn btn-primary" onclick="location.reload()">
                    <i class="fas fa-redo mr-2"></i>重试
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 文件大小格式化函数
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 显示选择的文件名
document.querySelector('.custom-file-input').addEventListener('change', function(e) {
    var file = document.getElementById("firmware_file").files[0];
    if (file) {
        var fileName = file.name;
        var nextSibling = e.target.nextElementSibling;
        nextSibling.innerText = fileName;
    }
});

// 表单提交处理
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const fileInput = document.getElementById('firmware_file');
    const file = fileInput.files[0];

    if (!file) {
        alert('请选择要上传的固件文件');
        return;
    }

    // 记录开始时间
    const startTime = Date.now();
    const minDisplayTime = 1000; // 最少显示1秒

    // 显示文件信息
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);

    // 显示上传模态框
    $('#uploadModal').modal('show');

    // 创建FormData对象
    const formData = new FormData(this);

    // 创建XMLHttpRequest对象
    const xhr = new XMLHttpRequest();

    // 上传进度监听
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const uploadStatus = document.getElementById('uploadStatus');

            progressBar.style.width = percentComplete + '%';
            progressBar.setAttribute('aria-valuenow', percentComplete);
            progressText.textContent = Math.round(percentComplete) + '%';

            if (percentComplete < 100) {
                uploadStatus.textContent = `正在上传... ${formatFileSize(e.loaded)} / ${formatFileSize(e.total)}`;
            } else {
                uploadStatus.textContent = '上传完成，正在处理...';
                progressBar.classList.remove('progress-bar-animated');
            }
        }
    });

    // 处理上传完成的函数
    function handleUploadComplete(success, errorMessage = '') {
        const elapsedTime = Date.now() - startTime;
        const remainingTime = Math.max(0, minDisplayTime - elapsedTime);

        // 确保至少显示1秒
        setTimeout(function() {
            $('#uploadModal').modal('hide');

            if (success) {
                $('#successModal').modal('show');
            } else {
                document.getElementById('errorMessage').textContent = errorMessage;
                $('#errorModal').modal('show');
            }
        }, remainingTime);
    }

    // 请求完成监听
    xhr.addEventListener('load', function() {
        if (xhr.status === 200) {
            // 检查响应是否包含错误
            const response = xhr.responseText;
            if (response.includes('error') || response.includes('失败')) {
                handleUploadComplete(false, '固件上传处理失败，请重试');
            } else {
                // 显示100%进度和完成状态
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const uploadStatus = document.getElementById('uploadStatus');

                progressBar.style.width = '100%';
                progressBar.setAttribute('aria-valuenow', 100);
                progressText.textContent = '100%';
                uploadStatus.textContent = '固件上传完成！';
                progressBar.classList.remove('progress-bar-animated');

                handleUploadComplete(true);
            }
        } else {
            handleUploadComplete(false, `服务器错误 (${xhr.status})`);
        }
    });

    // 请求错误监听
    xhr.addEventListener('error', function() {
        handleUploadComplete(false, '网络连接错误，请检查网络后重试');
    });

    // 开始上传
    xhr.open('POST', this.action);
    xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    xhr.send(formData);

    // 更新状态
    document.getElementById('uploadStatus').textContent = '正在连接服务器...';
});
</script>

<style>
/* 上传动画 */
@keyframes uploadPulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

#uploadIcon {
    animation: uploadPulse 1.5s infinite;
}

.progress {
    height: 25px;
    border-radius: 15px;
    overflow: hidden;
}

.progress-bar {
    transition: width 0.3s ease;
    font-weight: bold;
}

.modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.upload-animation {
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

{% endblock main_content %}